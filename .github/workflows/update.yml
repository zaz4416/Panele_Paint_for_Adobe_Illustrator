name: Sync Common Folder
on:
  repository_dispatch:
    types: [common_lib_updated]

jobs:
  sync:
    # --- 1. ループ防止判定（自己PR防止） ---
    # 送信元の target_repo と 自分の名前（github.repository）が
    # 【一致しない】ときだけ実行する
    #if: |
    #  github.event.client_payload.target_repo != null &&
    #  format('{0}', github.event.client_payload.target_repo) != github.repository
    # 判定：送信元が自分自身でない、かつ、既に同期用ブランチが存在しない場合のみ実行
    if: |
      (github.event.client_payload.target_repo == null || 
       github.event.client_payload.target_repo != github.repository)

    runs-on: ubuntu-latest
    steps:
      # --- 2. デバッグ用：ログで不一致の原因を特定する ---
      - name: Debug Context Check
        run: |
          echo "--- Context Check ---"
          echo "Payload (from ZazLib): '${{ github.event.client_payload.target_repo }}'"
          echo "Current (This Repo):  '${{ github.repository }}'"
          echo "---------------------"

      # --- 3. リポジトリのチェックアウト ---
      - name: Checkout Project Repo
        uses: actions/checkout@v4
        with:
          path: project-repo

      - name: Checkout Common Lib Repo
        uses: actions/checkout@v4
        with:
          repository: zaz4416/ZazLib # ★共通リポジトリ名
          token: ${{ secrets.MY_PAT }}
          path: common-lib

      # --- 4. フォルダ同期（rsync） ---
      - name: Sync zazlib Folder
        run: |
          # コピー先フォルダを強制作成
          mkdir -p project-repo/zazlib/
          
          echo "--- Directory Structure Check ---"
          ls -R common-lib
          
          # 同期実行
          # -vv をつけることで、スキップされた理由（uptodate等）を詳細にログ出力します
          # common-lib/ の末尾スラッシュは「中身」を指します
          rsync -avv --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            common-lib/ project-repo/zazlib/

      # --- 5. 変更があればプルリクエスト作成 ---
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          path: project-repo
          token: ${{ secrets.MY_PAT }}
          commit-message: "🤖 ${{ github.repository }} の zazlib を更新"
          branch: sync-common-library
          
          # タイトルに変更先のリポジトリ名を入れる
          title: "🤖 Zazlib同期 [target: ${{ github.repository }}]"
          
          # 本文に詳細を記載
          body: |
            ## 共通ライブラリ(Zazlib)の自動同期レポート
            
            **同期先リポジトリ:** 
            - [${{ github.repository }}](https://github.com/${{ github.repository }})
            
            **更新のトリガー:** 
            - 送信元: ${{ github.event.client_payload.target_repo || 'ZazLib 直接更新' }}
            
            共通リポジトリ(ZazLib)の最新の `zazlib` フォルダ内容を反映しました。
            VSCode の [GitHub Pull Requests](https://marketplace.visualstudio.com) 拡張機能で内容を確認し、マージしてください。
          
          # マージ後に不要になった作業ブランチを自動で削除する
          delete-branch: true