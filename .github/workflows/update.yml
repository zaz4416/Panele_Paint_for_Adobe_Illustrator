name: Sync Common Folder
on:
  repository_dispatch:
    types: [common_lib_updated]

jobs:
  sync:
    # --- 1. ループ防止判定（自己PR防止） ---
    # 送信元の target_repo と 自分の名前（github.repository）が
    # 【一致しない】ときだけ実行する
    #if: |
    #  github.event.client_payload.target_repo != null &&
    #  format('{0}', github.event.client_payload.target_repo) != github.repository

    runs-on: ubuntu-latest
    steps:
      # --- 2. デバッグ用：ログで不一致の原因を特定する ---
      - name: Debug Context Check
        run: |
          echo "--- Context Check ---"
          echo "Payload (from ZazLib): '${{ github.event.client_payload.target_repo }}'"
          echo "Current (This Repo):  '${{ github.repository }}'"
          echo "---------------------"

      # --- 3. リポジトリのチェックアウト ---
      - name: Checkout Project Repo
        uses: actions/checkout@v4
        with:
          path: project-repo

      - name: Checkout Common Lib Repo
        uses: actions/checkout@v4
        with:
          repository: zaz4416/ZazLib # ★共通リポジトリ名
          token: ${{ secrets.MY_PAT }}
          path: common-lib

      # --- 4. フォルダ同期（rsync） ---
      - name: Sync zazlib Folder
        run: |
          mkdir -p project-repo/zazlib/
          # 共通側のルートをプロジェクトのzazlibへ同期（Git情報は除外）
          rsync -av --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            common-lib/ project-repo/zazlib/

      # --- 5. 変更があればプルリクエスト作成 ---
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          path: project-repo
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "🤖 共通ライブラリを最新に同期（元: ${{ github.event.client_payload.target_repo || 'ZazLib' }}）"
          branch: sync-common-library
          # タイトルにリポジトリ名を入れる
          title: "🤖 共通ライブラリ同期 [from: ${{ github.event.client_payload.target_repo || 'ZazLib' }}]"
          # 本文に詳細なリンクなどを入れる
          body: |
            共通リポジトリ(ZazLib)からの更新通知を受信しました。
            
            **更新のきっかけとなったリポジトリ:** 
            https://github.com{{ github.event.client_payload.target_repo || 'zaz4416/ZazLib' }}
            
            `zazlib` フォルダの内容を最新状態に同期しました。